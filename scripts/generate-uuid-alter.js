#!/usr/bin/env node
/**
 * scans the public schema for columns named '%_id' that are not type uuid,
 * checks for bad values, and writes a reviewed SQL migration file with
 * `ALTER TABLE ... ALTER COLUMN ... TYPE uuid USING column::uuid` statements
 * for columns that are safe to cast.
 *
 * Usage: DATABASE_URL="..." node scripts/generate-uuid-alter.js
 */
const { Client } = require('pg');
const fs = require('fs');
const path = require('path');

const UUID_REGEX = '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$';

async function main() {
  const databaseUrl = process.env.DATABASE_URL;
  if (!databaseUrl) {
    console.error('DATABASE_URL is required');
    process.exit(2);
  }

  const client = new Client({ connectionString: databaseUrl });
  await client.connect();

  // find candidate columns
  const colsRes = await client.query(
    `SELECT table_name, column_name
     FROM information_schema.columns
     WHERE table_schema = 'public'
       AND column_name LIKE '%\_id'
       AND data_type != 'uuid'
     ORDER BY table_name`);

  if (colsRes.rows.length === 0) {
    console.log('No non-uuid *_id columns found.');
    await client.end();
    return;
  }

  const checks = [];
  for (const r of colsRes.rows) {
    const table = r.table_name;
    const col = r.column_name;

    const checkSql = `SELECT COUNT(*)::int AS bad_count FROM "${table}" WHERE "${col}" IS NOT NULL AND "${col}" !~* '${UUID_REGEX}';`;
    const badRes = await client.query(checkSql);
    const badCount = badRes.rows[0].bad_count;
    checks.push({ table, col, badCount });
  }

  const safeToCast = checks.filter(c => c.badCount === 0);
  const unsafe = checks.filter(c => c.badCount > 0);

  const outDir = path.join(process.cwd(), 'migrations');
  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
  const outFile = path.join(outDir, 'fix-uuid-columns.sql');

  const header = `-- Auto-generated migration candidate: fix-uuid-columns.sql\n-- Run only after reviewing and backing up your database.\n-- Generated by scripts/generate-uuid-alter.js\n\n`;

  const lines = [header];

  if (unsafe.length > 0) {
    lines.push('-- WARNING: The following columns have non-UUID-looking values and will need manual inspection:');
    for (const u of unsafe) {
      lines.push(`-- ${u.table}.${u.col} -> ${u.badCount} non-UUID value(s)`);
    }
    lines.push('\n-- Fix or remove bad values before attempting to cast these columns.');
  }

  if (safeToCast.length > 0) {
    lines.push('\nBEGIN;');
    for (const s of safeToCast) {
      lines.push(`\n-- Casting ${s.table}.${s.col} to uuid`);
      lines.push(`ALTER TABLE "${s.table}" ALTER COLUMN "${s.col}" TYPE uuid USING ("${s.col}")::uuid;`);
    }
    lines.push('\nCOMMIT;\n');
  } else {
    lines.push('\n-- No columns safe to cast were found.');
  }

  fs.writeFileSync(outFile, lines.join('\n'));

  console.log('Wrote migration candidate to', outFile);
  if (unsafe.length > 0) {
    console.log('Unsafe columns detected â€” review and fix their values before applying the migration.');
  }

  await client.end();
}

main().catch(err => {
  console.error(err);
  process.exit(1);
});
